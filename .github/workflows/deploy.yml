name: Deploy eNPS Reports Generator

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      quarter_offset:
        description: 'Quarter offset (-1 for previous quarter, -2 for quarter before last, etc.)'
        required: false
        default: '-1'
      run_excel_only:
        description: 'Generate only Excel file (true/false)'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t enpsreportsgenerator:latest .

      - name: Save Docker image
        run: docker save enpsreportsgenerator:latest | gzip > enpsreportsgenerator.tar.gz

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "enpsreportsgenerator.tar.gz,requirements.txt,Dockerfile,.env.example"
          target: "/opt/enps_reports_generator"
          strip_components: 0

      - name: Deploy and setup on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/enps_reports_generator
            
            # Получаем параметры из workflow_dispatch или используем значения по умолчанию
            QUARTER_OFFSET="${{ github.event.inputs.quarter_offset || '-1' }}"
            RUN_EXCEL_ONLY="${{ github.event.inputs.run_excel_only || 'false' }}"
            
            echo "Using parameters: quarter_offset=$QUARTER_OFFSET, run_excel_only=$RUN_EXCEL_ONLY"
            
            # Создаем .env файл
            cat > .env << EOF
            DB_HOST=${{ secrets.DB_HOST || 'localhost' }}
            DB_PORT=${{ secrets.DB_PORT || '5432' }}
            DB_NAME=${{ secrets.DB_NAME || 'enps' }}
            DB_USER=${{ secrets.DB_USER || 'postgres' }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD || 'por_pas_123' }}
            
            LITELLM_API_KEY=${{ secrets.LITELLM_API_KEY }}
            LITELLM_MODEL_NAME=${{ secrets.LITELLM_MODEL_NAME || 'openai-gpt-5-mini' }}
            LITELLM_BASE_URL=${{ secrets.LITELLM_BASE_URL || 'https://litellm.poryadok.ru' }}
            
            BITRIX_TOKEN=${{ secrets.BITRIX_TOKEN }}
            BITRIX_USER_ID=${{ secrets.BITRIX_USER_ID || '163472' }}
            BITRIX_ENPS_REPORTS_FOLDER_ID=${{ secrets.BITRIX_ENPS_REPORTS_FOLDER_ID || '5057340' }}
            
            PORADOCK_TOKEN=${{ secrets.PORADOCK_TOKEN || '' }}
            
            WKHTMLTOPDF_PATH=/usr/local/bin/wkhtmltopdf
            OUTPUT_DIR=/app/output_reports
            
            # Переменные для runtime (будут переопределены при запуске контейнера)
            QUARTER_OFFSET=$QUARTER_OFFSET
            RUN_EXCEL_ONLY=$RUN_EXCEL_ONLY
            EOF

            # Загружаем Docker образ
            docker load < enpsreportsgenerator.tar.gz
            
            # Останавливаем старые контейнеры
            docker stop ENPSReportsGenerator 2>/dev/null || true
            docker rm ENPSReportsGenerator 2>/dev/null || true
            
            echo "Starting container with parameters: quarter_offset=$QUARTER_OFFSET, run_excel_only=$RUN_EXCEL_ONLY"
            
            # Запускаем контейнер
            docker run -d \
              --name ENPSReportsGenerator \
              --network host \
              --env-file .env \
              -e QUARTER_OFFSET="$QUARTER_OFFSET" \
              -e RUN_EXCEL_ONLY="$RUN_EXCEL_ONLY" \
              enpsreportsgenerator:latest
            
            echo "Container started"
            
            # Ждем завершения и проверяем логи
            sleep 30
            
            echo "=== Container logs ==="
            docker logs ENPSReportsGenerator 2>&1 | tail -100
            
            # Проверяем статус
            if docker ps -a --format "table {{.Names}}\t{{.Status}}" | grep ENPSReportsGenerator | grep -q "Exited (0)"; then
              echo "SUCCESS: Container completed successfully"
            elif docker ps --format "table {{.Names}}" | grep -q ENPSReportsGenerator; then
              echo "INFO: Container is still running (this may be normal for long tasks)"
            else
              echo "WARNING: Container status unknown"
            fi
            
            # Настраиваем cron job для автоматического запуска
            echo "Setting up cron job..."
            
            cat > run_enps_report.sh << 'SCRIPT_EOF'
            #!/bin/bash
            cd /opt/enps_reports_generator
            
            # Удаляем старый контейнер, если есть
            docker rm -f ENPSReportsGenerator_cron 2>/dev/null || true
            
            # Запускаем генерацию отчетов за предыдущий квартал
            docker run --name ENPSReportsGenerator_cron --network host --env-file .env \
              -e QUARTER_OFFSET="-1" \
              -e RUN_EXCEL_ONLY="false" \
              --rm \
              enpsreportsgenerator:latest
              
            echo "[$(date)] eNPS report generated for previous quarter" >> /opt/enps_reports_generator/enps_reports.log
            SCRIPT_EOF
            
            chmod +x run_enps_report.sh

            # Устанавливаем cron job на 1 число каждого квартала в 3:00 (продакшен)
            (crontab -l 2>/dev/null | grep -v "run_enps_report.sh") | crontab -
            (crontab -l 2>/dev/null; echo "0 3 1 1,4,7,10 * /opt/enps_reports_generator/run_enps_report.sh >> /opt/enps_reports_generator/enps_reports_cron.log 2>&1") | crontab -
            
            # Тестовый запуск каждый день в 17:10
            (crontab -l 2>/dev/null; echo "10 17 * * * /opt/enps_reports_generator/run_enps_report.sh >> /opt/enps_reports_generator/enps_reports_test.log 2>&1") | crontab -

            echo "Cron jobs installed:"
            crontab -l

            # Очистка старых Docker образов (оставляем последние 3)
            echo "Cleaning up old Docker images..."
            docker images enpsreportsgenerator --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi 2>/dev/null || true
            rm -f enpsreportsgenerator.tar.gz
            
            echo "Deployment successful!"

      - name: Cleanup local files
        if: always()
        run: rm -f enpsreportsgenerator.tar.gz

      - name: Notify on success
        if: success()
        run: echo "eNPS Reports Generator deployed successfully!"