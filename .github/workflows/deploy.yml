# .github/workflows/deploy.yml
name: Deploy eNPS Reports Generator

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      quarter_offset:
        description: 'Quarter offset (-1 for previous quarter, -2 for quarter before last, etc.)'
        required: false
        default: '-1'
      run_excel_only:
        description: 'Generate only Excel file (true/false)'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t enpsreportsgenerator:latest .

      - name: Save Docker image
        run: docker save enpsreportsgenerator:latest | gzip > enpsreportsgenerator.tar.gz

      - name: Create directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            mkdir -p /home/deploy/enps_reports_generator
            chmod 755 /home/deploy/enps_reports_generator

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "enpsreportsgenerator.tar.gz,requirements.txt,Dockerfile,.env.example"
          target: "/home/deploy/enps_reports_generator"
          strip_components: 0

      - name: Deploy and setup on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /home/deploy/enps_reports_generator
            
            # Получаем параметры из workflow_dispatch или используем значения по умолчанию
            QUARTER_OFFSET="${{ github.event.inputs.quarter_offset || '-1' }}"
            RUN_EXCEL_ONLY="${{ github.event.inputs.run_excel_only || 'false' }}"
            
            echo "Using parameters: quarter_offset=$QUARTER_OFFSET, run_excel_only=$RUN_EXCEL_ONLY"
            
            # Создаем .env файл
            cat > .env << EOF
            DB_HOST=${{ secrets.DB_HOST || 'localhost' }}
            DB_PORT=${{ secrets.DB_PORT || '5432' }}
            DB_NAME=${{ secrets.DB_NAME || 'enps' }}
            DB_USER=${{ secrets.DB_USER || 'postgres' }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD || 'por_pas_123' }}
            
            LITELLM_API_KEY=${{ secrets.LITELLM_API_KEY }}
            LITELLM_MODEL_NAME=${{ secrets.LITELLM_MODEL_NAME || 'openai-gpt-5-mini' }}
            LITELLM_BASE_URL=${{ secrets.LITELLM_BASE_URL || 'https://litellm.poryadok.ru' }}
            
            BITRIX_TOKEN=${{ secrets.BITRIX_TOKEN }}
            BITRIX_USER_ID=${{ secrets.BITRIX_USER_ID || '163472' }}
            BITRIX_ENPS_REPORTS_FOLDER_ID=${{ secrets.BITRIX_ENPS_REPORTS_FOLDER_ID || '5057340' }}
            
            PORADOCK_TOKEN=${{ secrets.PORADOCK_TOKEN || '' }}
            
            WKHTMLTOPDF_PATH=/usr/local/bin/wkhtmltopdf
            OUTPUT_DIR=/app/output_reports
            
            # Переменные для runtime (будут переопределены при запуске контейнера)
            QUARTER_OFFSET=$QUARTER_OFFSET
            RUN_EXCEL_ONLY=$RUN_EXCEL_ONLY
            EOF

            # Загружаем Docker образ
            docker load < enpsreportsgenerator.tar.gz
            
            # Останавливаем старые контейнеры
            docker stop ENPSReportsGenerator 2>/dev/null || true
            docker rm ENPSReportsGenerator 2>/dev/null || true
            
            echo "Starting container with parameters: quarter_offset=$QUARTER_OFFSET, run_excel_only=$RUN_EXCEL_ONLY"
            
            # Запускаем контейнер
            CONTAINER_ID=$(docker run -d \
              --name ENPSReportsGenerator \
              --network host \
              --env-file .env \
              -e QUARTER_OFFSET="$QUARTER_OFFSET" \
              -e RUN_EXCEL_ONLY="$RUN_EXCEL_ONLY" \
              enpsreportsgenerator:latest)
            
            echo "Container started with ID: $CONTAINER_ID"
            
            # Ждем и проверяем статус
            sleep 10
            
            # Проверяем статус контейнера
            CONTAINER_STATUS=$(docker inspect ENPSReportsGenerator --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
            echo "Container status after 10s: $CONTAINER_STATUS"
            
            if [ "$CONTAINER_STATUS" = "not_found" ]; then
              echo "ERROR: Container not found"
              exit 1
            fi
            
            # Показываем логи
            echo "=== Container logs (last 50 lines) ==="
            docker logs --tail 50 ENPSReportsGenerator 2>&1 || echo "Cannot get logs"
            echo "=== End of logs ==="
            
            # Ждем завершения
            sleep 5
            
            # Проверяем финальный статус
            CONTAINER_STATUS=$(docker inspect ENPSReportsGenerator --format='{{.State.Status}}' 2>/dev/null || echo "not_found")
            EXIT_CODE=$(docker inspect ENPSReportsGenerator --format='{{.State.ExitCode}}' 2>/dev/null || echo "unknown")
            
            echo "Final container status: $CONTAINER_STATUS"
            echo "Container exit code: $EXIT_CODE"
            
            if [ "$CONTAINER_STATUS" = "exited" ]; then
              if [ "$EXIT_CODE" -eq 0 ]; then
                echo "Container completed successfully with exit code: $EXIT_CODE"
                echo "This is normal for one-time tasks. Container finished its work."
              else
                echo "ERROR: Container exited with code: $EXIT_CODE"
                echo "=== Full container logs ==="
                docker logs ENPSReportsGenerator 2>&1 || echo "Cannot get logs"
                exit 1
              fi
            elif [ "$CONTAINER_STATUS" = "running" ]; then
              echo "Container is still running"
            else
              echo "WARNING: Container status is: $CONTAINER_STATUS"
              docker logs ENPSReportsGenerator 2>&1 || echo "Cannot get logs"
            fi
            
            # Настраиваем cron job для автоматического запуска
            echo "Setting up cron job..."
            
            cat > run_enps_report.sh << 'SCRIPT_EOF'
            #!/bin/bash
            cd /home/deploy/enps_reports_generator
            
            # Удаляем старый контейнер, если есть
            docker rm -f ENPSReportsGenerator_cron 2>/dev/null || true
            
            # Запускаем генерацию отчетов за предыдущий квартал
            docker run --name ENPSReportsGenerator_cron --network host --env-file .env \
              -e QUARTER_OFFSET="-1" \
              -e RUN_EXCEL_ONLY="false" \
              --rm \
              enpsreportsgenerator:latest
              
            echo "[$(date)] eNPS report generated for previous quarter" >> /home/deploy/enps_reports_generator/enps_reports.log
            SCRIPT_EOF
            
            chmod +x run_enps_report.sh

            # Устанавливаем cron job на 1 число каждого квартала в 3:00
            (crontab -l 2>/dev/null | grep -v "run_enps_report.sh") | crontab -
            (crontab -l 2>/dev/null; echo "0 3 1 1,4,7,10 * /home/deploy/enps_reports_generator/run_enps_report.sh >> /home/deploy/enps_reports_generator/enps_reports_cron.log 2>&1") | crontab -
            
            # Для тестирования - запуск каждый день в 14:00 (можно удалить в продакшене)
            (crontab -l 2>/dev/null; echo "0 14 * * * /home/deploy/enps_reports_generator/run_enps_report.sh >> /home/deploy/enps_reports_generator/enps_reports_test.log 2>&1") | crontab -

            echo "Cron jobs installed:"
            crontab -l

            # Очистка старых Docker образов
            echo "Cleaning up old Docker images..."
            docker images enpsreportsgenerator --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi 2>/dev/null || true
            rm -f enpsreportsgenerator.tar.gz
            echo "Deployment successful!"