name: Deploy eNPS Reports Generator

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      quarter_offset:
        description: 'Quarter offset (-1 for previous quarter, -2 for quarter before last, etc.)'
        required: false
        default: '-1'
      run_excel_only:
        description: 'Generate only Excel file (true/false)'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker build -t enpsreportsgenerator:latest .

      - name: Save Docker image
        run: docker save enpsreportsgenerator:latest | gzip > enpsreportsgenerator.tar.gz

      - name: Create directory structure on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Создаем директорию с правильными правами (КАК В CALLQ)
            sudo mkdir -p /opt/enps_reports_generator/{output,logs}
            sudo chown -R deploy:deploy /opt/enps_reports_generator
            sudo chmod -R 755 /opt/enps_reports_generator
            echo "Directory structure created"

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          source: "enpsreportsgenerator.tar.gz,requirements.txt,Dockerfile,.env.example, src/"
          target: "/opt/enps_reports_generator"
          strip_components: 0

      - name: Fix permissions after copy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/enps_reports_generator
            # Исправляем права после копирования
            sudo chown -R deploy:deploy /opt/enps_reports_generator
            sudo chmod -R 755 /opt/enps_reports_generator
            echo "Permissions fixed"

      - name: Deploy and setup on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/enps_reports_generator
            
            # Проверяем что файлы есть
            echo "Files in directory:"
            ls -la
            
            # Проверяем архив
            if [ ! -f "enpsreportsgenerator.tar.gz" ]; then
              echo "ERROR: enpsreportsgenerator.tar.gz not found!"
              exit 1
            fi
            
            # Загружаем Docker образ (КАК В CALLQ)
            echo "Loading Docker image..."
            docker load < enpsreportsgenerator.tar.gz
            
            # Проверяем что образ загрузился
            echo "Docker images after load:"
            docker images | grep enpsreportsgenerator || echo "Image not found!"
            
            # Создаем .env файл
            cat > .env << EOF
            DB_HOST=${{ secrets.DB_HOST || 'localhost' }}
            DB_PORT=${{ secrets.DB_PORT || '5432' }}
            DB_NAME=${{ secrets.DB_NAME || 'enps' }}
            DB_USER=${{ secrets.DB_USER || 'postgres' }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD || 'por_pas_123' }}
            
            LITELLM_API_KEY=${{ secrets.LITELLM_API_KEY }}
            LITELLM_MODEL_NAME=${{ secrets.LITELLM_MODEL_NAME || 'openai-gpt-5-mini' }}
            LITELLM_BASE_URL=${{ secrets.LITELLM_BASE_URL || 'https://litellm.poryadok.ru' }}
            
            BITRIX_TOKEN=${{ secrets.BITRIX_TOKEN }}
            BITRIX_USER_ID=${{ secrets.BITRIX_USER_ID || '163472' }}
            BITRIX_ENPS_REPORTS_FOLDER_ID=${{ secrets.BITRIX_ENPS_REPORTS_FOLDER_ID || '5057340' }}
            
            PORADOCK_TOKEN=${{ secrets.PORADOCK_TOKEN || '' }}
            
            WKHTMLTOPDF_PATH=/usr/local/bin/wkhtmltopdf
            OUTPUT_DIR=/app/output_reports
            
            QUARTER_OFFSET=-1
            RUN_EXCEL_ONLY=false
            EOF
            
            chmod 600 .env
            
            # Создаем скрипт для запуска
            cat > run_enps_report.sh << 'SCRIPT_EOF'
            #!/bin/bash
            cd /opt/enps_reports_generator
            
            # Удаляем старый контейнер, если есть
            docker rm -f ENPSReportsGenerator_cron 2>/dev/null || true
            
            # Запускаем генерацию отчетов за предыдущий квартал
            docker run --name ENPSReportsGenerator_cron --network host --env-file .env \
              -e QUARTER_OFFSET="-1" \
              -e RUN_EXCEL_ONLY="false" \
              --rm \
              enpsreportsgenerator:latest
              
            echo "[$(date)] eNPS report generated for previous quarter" >> /opt/enps_reports_generator/enps_reports.log
            SCRIPT_EOF
            
            chmod +x run_enps_report.sh
            
            echo "Deployment files created"

      - name: Update cron jobs (КАК В CALLQ)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Создаем временный crontab файл (КАК В CALLQ)
            TMP_CRON=$(mktemp)
            
            # Сохраняем текущий crontab пользователя deploy
            sudo -u deploy crontab -l > "$TMP_CRON" 2>/dev/null || touch "$TMP_CRON"
            
            # Удаляем старые задачи enps (если есть)
            sed -i '/enps/d' "$TMP_CRON"
            
            # Добавляем новые задачи
            cat >> "$TMP_CRON" << 'EOF'
            # eNPS Reports - продакшен (1 число каждого квартала в 3:00)
            0 3 1 1,4,7,10 * /opt/enps_reports_generator/run_enps_report.sh >> /opt/enps_reports_generator/enps_reports_cron.log 2>&1
            
            # eNPS Reports - тестовый запуск (каждый день в 17:10)
            25 13 * * * /opt/enps_reports_generator/run_enps_report.sh >> /opt/enps_reports_generator/enps_reports_test.log 2>&1
            EOF
            
            # Устанавливаем новый crontab для пользователя deploy (КАК В CALLQ)
            sudo -u deploy crontab "$TMP_CRON"
            rm "$TMP_CRON"
            
            # Показываем текущий crontab
            echo "Current crontab for deploy user:"
            sudo -u deploy crontab -l | grep enps || echo "No enps jobs found"

      - name: Cleanup local files
        if: always()
        run: rm -f enpsreportsgenerator.tar.gz

      - name: Notify on success
        if: success()
        run: echo "eNPS Reports Generator deployed successfully!"